#!/bin/bash -p

#
# COPYRIGHT 2018, Cerebras Systems, Inc.
#

NAME=smproxy
CM_ADDR=10.0.0.6:22
PROXY_PORT=2222

start()
{
    if [[ -f /var/run/smproxy.pid ]]; then
        echo "there is already a proxy running at PID $(cat /var/run/smproxy.pid)"
        exit 1
    fi
    /usr/bin/socat TCP-LISTEN:$PROXY_PORT,reuseaddr,fork,su=nobody TCP:$CM_ADDR &
    /bin/echo $! > /var/run/smproxy.pid
}

stop()
{
    if [[ ! -f /var/run/smproxy.pid ]]; then
        echo "there is no proxy currently running"
        exit 1
    fi
    /bin/kill $(cat /var/run/smproxy.pid)
    rm /var/run/smproxy.pid
}


case "$1" in
    start)
        start ;;
    stop)
        stop ;;
    restart|reload)
        stop; start ;;
    *)
        echo "Usage: %0 {start|stop|restart}"
        exit 1
esac

exit 0
